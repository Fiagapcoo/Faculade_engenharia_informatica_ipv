import cv2
import numpy as np
import subprocess
import time
import json
import os

def capture_image_rpicam():
    """Capture an image using rpicam-still and return as numpy array"""
    # Create temporary file for the image
    temp_file = '/tmp/motion_capture.jpg'
    
    # Capture image using rpicam-still
    subprocess.run([
        'rpicam-still',
        '-n',  # No preview
        '-t', '1',  # Very short delay
        '--immediate',  # Capture immediately
        '-o', temp_file
    ])
    
    # Read the image with OpenCV
    frame = cv2.imread(temp_file)
    
    # Clean up temporary file
    os.remove(temp_file)
    
    return frame

def detect_motion(frame1, frame2, min_area=500):
    # Find difference between frames
    diff = cv2.absdiff(frame1, frame2)
    gray = cv2.cvtColor(diff, cv2.COLOR_BGR2GRAY)
    blur = cv2.GaussianBlur(gray, (5, 5), 0)
    _, thresh = cv2.threshold(blur, 20, 255, cv2.THRESH_BINARY)
    dilated = cv2.dilate(thresh, None, iterations=3)
    
    # Find contours
    contours, _ = cv2.findContours(dilated, cv2.RETR_TREE, cv2.CHAIN_APPROX_SIMPLE)
    
    for contour in contours:
        (x, y, w, h) = cv2.boundingRect(contour)
        if cv2.contourArea(contour) < min_area:
            continue
            
        # Draw rectangle around the moving object
        cv2.rectangle(frame1, (x, y), (x+w, y+h), (0, 255, 0), 2)
        
        # Calculate center point
        center_x = x + w//2
        center_y = y + h//2
        cv2.circle(frame1, (center_x, center_y), 4, (0, 0, 255), -1)
        
        # Draw crosshair
        cv2.line(frame1, (center_x - 10, center_y), (center_x + 10, center_y), (0, 0, 255), 1)
        cv2.line(frame1, (center_x, center_y - 10), (center_x, center_y + 10), (0, 0, 255), 1)
        
    return frame1

def main():
    print("Starting motion detection...")
    print("Press 'q' to quit")
    
    try:
        while True:
            # Capture two frames for motion detection
            frame1 = capture_image_rpicam()
            time.sleep(0.1)  # Small delay between captures
            frame2 = capture_image_rpicam()
            
            if frame1 is None or frame2 is None:
                print("Error capturing frames")
                continue
            
            # Process frames
            processed_frame = detect_motion(frame1.copy(), frame2.copy())
            
            # Display the result
            cv2.imshow("Motion Tracking", processed_frame)
            
            # Press 'q' to quit
            if cv2.waitKey(1) & 0xFF == ord('q'):
                break
                
    finally:
        cv2.destroyAllWindows()

if __name__ == "__main__":
    main()
